# 碎片收集与AI合成系统

## 功能概述

1. **碎片生成**：点击鸟类时生成单一身体部位碎片（头、胸、腹、翼、尾、足）
2. **胶卷存储**：碎片存储到临时胶卷，最多10个
3. **UI显示**：右下角胶卷圆盘，中间显示单个数字，圆周有正方形镂空格子，每捕捉一个鸟类就转一下，数字增加
4. **AI合成**：伪AI算法按身体部位组合碎片成完整鸟类模型（点击预览时才生成，不随数字增加运行）
5. **结果展示（当前页面展示）**：点击胶卷圆盘后**在当前页面**以模态/浮层或场景中心直接展示合成后的3D模型；生成延迟时在页面中显示转圈圈UI和\"正在合成\"提示（不跳转到另一个页面）

---

## 技术架构

### 1. 碎片生成模块 (`src/modules/birdFragment.js`)

**功能**：生成单一身体部位碎片

**身体部位定义**：
- `head` - 头部（球体，可能带眼睛）
- `chest` - 胸部（主体球体）
- `belly` - 腹部（主体球体变体）
- `wing` - 翅膀（半圆球，可多个）
- `tail` - 尾部（装饰/盒子）
- `foot` - 足部（小几何体）

**导出函数**：
- `createBirdFragment(partType, options)` - 生成指定部位的碎片
  - 参数：`partType` - 'head' | 'chest' | 'belly' | 'wing' | 'tail' | 'foot'
  - 返回：`THREE.Group` 对象（单一部位3D模型）

**生成规则**：
- 每个部位独立生成，不依赖完整鸟类
- 保持与现有鸟类风格一致（球体、随机颜色、点云蒙皮）
- 每个碎片包含 `userData.partType` 标识

---

### 2. 胶卷状态管理 (`src/modules/filmRollState.js`)

**功能**：管理碎片收集状态

**数据结构**：
```javascript
{
  fragments: [
    {
      id: string,              // 唯一ID
      partType: string,        // 'head' | 'chest' | 'belly' | 'wing' | 'tail' | 'foot'
      timestamp: number,       // 捕获时间
      fragment: THREE.Group,   // 碎片3D对象
      thumbnail: string        // 缩略图base64（可选）
    }
  ],
  maxFragments: 10,           // 最大碎片数
  minFragments: 3             // 最小合成数（头胸腹）
}
```

**导出函数**：
- `addFragment(partType)` - 添加碎片（如果未达上限）
- `getFragments()` - 获取所有碎片
- `getFragmentCount()` - 获取碎片数量
- `canSynthesize()` - 检查是否可以合成（≥3个）
- `clearFragments()` - 清空胶卷

**碎片生成策略**：
- 点击鸟类时，随机选择身体部位类型
- 或按顺序循环：头→胸→腹→翼→尾→足
- 生成对应部位的碎片并添加到胶卷
- **注意**：碎片只存储，不立即合成，合成在点击预览时触发

---

### 3. AI合成模块 (`src/modules/aiSynthesis.js`)

**功能**：伪AI算法，按身体部位组合碎片

**合成规则**：

1. **基础组合**（3个碎片：头+胸+腹）：
   - 头部放在顶部
   - 胸部放在中间
   - 腹部放在底部
   - 按比例缩放，确保连接自然

2. **完整组合**（最多10个碎片）：
   - 头部：顶部
   - 胸部：中上
   - 腹部：中下
   - 翅膀：胸部两侧（对称或不对称）
   - 尾部：底部后方
   - 足部：底部（可选，1-2个）

**合成算法**：
```javascript
function synthesizeCreature(fragments) {
  const creature = new THREE.Group();
  const parts = {
    head: null,
    chest: null,
    belly: null,
    wings: [],
    tail: null,
    feet: []
  };
  
  // 分类碎片
  fragments.forEach(f => {
    if (f.partType === 'head') parts.head = f;
    else if (f.partType === 'chest') parts.chest = f;
    // ...
  });
  
  // 按位置组装
  // 1. 放置胸部（中心参考点）
  // 2. 头部在胸部上方
  // 3. 腹部在胸部下方
  // 4. 翅膀在胸部两侧
  // 5. 尾部在腹部后方
  // 6. 足部在底部
  
  return creature;
}
```

**位置计算**：
- 使用包围盒（BoundingBox）计算每个部位尺寸
- 按比例调整位置，确保自然连接
- 应用随机旋转/偏移增加自然感

**导出函数**：
- `synthesizeCreature(fragments)` - 合成完整生物（异步，可能耗时）
  - 参数：`fragments` - 碎片数组
  - 返回：`Promise<THREE.Group>` - 异步返回合成后的3D模型

**合成时机**：
- **不在收集时合成**：碎片收集时只存储，不触发合成
- **点击预览时合成（在页面内展示）**：用户点击胶卷圆盘后，在当前页面触发合成并展示结果（可为浮层或直接在场景中心显示）
- **显示加载状态**：合成过程中显示页面内加载提示（转圈圈 + 文本）以告知用户进度

---

### 4. 胶卷UI组件 (`src/components/FilmRollUI.js`)

**功能**：右下角胶卷圆盘UI

**UI设计**：
- 位置：`position: fixed; bottom: 20px; right: 20px;`
- 样式：圆形胶卷样式
  - **中心**：显示单个数字（当前碎片数量，如 "3"）
  - **圆周**：正方形镂空格子（像胶卷边缘的孔洞），均匀分布
  - **旋转动画**：每捕捉一个鸟类时，圆盘旋转一定角度（如 36°），数字增加
- 状态：
  - 未达到3个：灰色，不可点击
  - 达到3个：可点击，显示高亮
  - 达到10个：显示满状态，可点击

**交互**：
- 点击后进入合成预览页面（另一个页面）
- 点击时触发合成流程（异步）

**导出函数**：
- `createFilmRollUI(onClick)` - 创建UI元素
  - 参数：`onClick` - 点击回调函数
  - 返回：DOM元素
- `updateFilmRollUI(count)` - 更新UI显示
  - 参数：`count` - 当前碎片数量
  - 功能：更新中心数字，触发旋转动画
- `rotateFilmRoll(angle)` - 旋转圆盘
  - 参数：`angle` - 旋转角度（度）

---

### 5. 合成结果页面 (`src/components/SynthesisResultPage.js`)

**功能**：展示合成结果（另一个独立页面）

**UI元素**：
- **加载状态**（合成中）：
  - 屏幕中间转圈圈UI（旋转动画）
  - 显示文字："正在合成..."
  - 半透明黑色背景遮罩
- **3D预览区域**（合成完成后）：
  - 独立Three.js场景，展示合成生物
  - 模型浮空展示（居中，可旋转查看）
  - 背景：深色/透明
- **碎片列表**：显示收集到的碎片缩略图
- **操作按钮**：
  - "保存"（可选）
  - "继续探索"（清空胶卷，关闭页面，返回场景）

**实现方式**：
- 全屏覆盖层（新页面）
- 点击圆盘后切换到此页面
- 合成完成后显示3D模型

**导出函数**：
- `showSynthesisResultPage(fragments)` - 显示结果页面并开始合成
  - 参数：`fragments` - 碎片数组
  - 功能：显示加载状态，异步调用合成函数，完成后显示模型
- `hideSynthesisResultPage()` - 隐藏结果页面，返回主场景
- `showLoadingUI()` - 显示加载状态（转圈圈 + "正在合成"）
- `hideLoadingUI()` - 隐藏加载状态

---

### 6. 主入口集成 (`src/index.js`)

**修改点**：

1. **点击事件增强**（第502行）：
   ```javascript
   renderer.domElement.addEventListener('pointerdown', (event) => {
     if (currentCameraMode !== 'birdWatch') return;
     
     // ... 现有射线检测代码 ...
     
     if (intersects.length > 0) {
       const selected = intersects[0].object.parent;
       
       // 新增：生成碎片并添加到胶卷
       const partTypes = ['head', 'chest', 'belly', 'wing', 'tail', 'foot'];
       const randomPartType = partTypes[Math.floor(Math.random() * partTypes.length)];
       // 或按顺序循环选择
       
       const fragment = createBirdFragment(randomPartType);
       addFragment(randomPartType, fragment);
       
       // 更新UI：数字增加，圆盘旋转
       const newCount = getFragmentCount();
       updateFilmRollUI(newCount);
       rotateFilmRoll(36); // 每次旋转36度（360/10）
       
       // ... 现有摄像机跟随代码 ...
     }
   });
   ```

2. **胶卷UI初始化**：
   ```javascript
   // 在 createCameraButtons() 之后
   const filmRollUI = createFilmRollUI(() => {
     if (canSynthesize()) {
       const fragments = getFragments();
       // 进入合成预览页面（异步合成）
       showSynthesisResultPage(fragments);
     }
   });
   document.body.appendChild(filmRollUI);
   ```

3. **UI更新逻辑**：
   ```javascript
   function updateFilmRollUI(count) {
     // 更新中心数字
     // 更新可点击状态（≥3个可点击）
     const canClick = count >= 3;
     // 更新UI样式
   }
   ```

---

## 文件结构

```
src/
├── index.js                    # 主入口（修改）
├── modules/
│   ├── birdFragment.js         # 碎片生成（新建）
│   ├── filmRollState.js        # 状态管理（新建）
│   ├── aiSynthesis.js          # AI合成（新建）
│   └── ...                     # 现有模块
└── components/
    ├── FilmRollUI.js           # 胶卷UI（新建）
    └── SynthesisResultPage.js  # 结果页面（新建）
```

---

## 实现细节

### 碎片生成细节

每个身体部位独立生成，参考现有 `randomBird.js` 的风格：
- **头部**：球体 + 可选眼睛
- **胸部**：主体球体（较大）
- **腹部**：主体球体（稍小）
- **翅膀**：半圆球，1-2个
- **尾部**：盒子/装饰几何体
- **足部**：小几何体（圆柱/球体）

所有碎片应用点云蒙皮（与现有鸟类一致）。

### 合成位置计算

使用包围盒计算每个部位的尺寸，然后按比例放置：
- 头部：胸部顶部 + 头部高度/2
- 胸部：中心点（y=0）
- 腹部：胸部底部 - 腹部高度/2
- 翅膀：胸部两侧，根据胸部宽度定位
- 尾部：腹部后方
- 足部：底部支撑点

### UI样式

**胶卷圆盘**：
- 圆形，直径约80-100px
- 背景：半透明黑色/白色，圆形
- **中心数字**：大号字体，居中显示单个数字（如 "3"）
- **圆周格子**：正方形镂空格子，均匀分布在圆周上（类似胶卷边缘孔洞）
  - 格子数量：10个（对应最大碎片数）
  - 格子大小：约8-10px
  - 格子样式：正方形，镂空（透明或半透明）
- **旋转动画**：每次捕捉鸟类时，圆盘旋转 36°（360/10），带动画过渡
- 状态颜色：灰色（不可用）→ 绿色/蓝色（可用）→ 金色（满）

**加载UI**（合成中）：
- 位置：屏幕正中央
- 转圈圈：圆形旋转动画（CSS animation 或 Canvas）
- 文字："正在合成..."，位于转圈圈下方
- 背景：半透明黑色遮罩（覆盖整个屏幕）

---

## 已确认设计

1. **碎片生成方式**：点击时随机选择部位，或按顺序循环（待实现时决定）
2. **胶卷圆盘样式**：圆形，中心显示单个数字，圆周有正方形镂空格子，每捕捉一个鸟类就转一下
3. **查看模型方式**：另一个独立页面，全屏覆盖，模型浮空展示
4. **合成规则**：≥3个碎片即可合成，不要求必须包含头胸腹
5. **合成时机**：点击预览时才生成合成，不随数字增加运行
6. **加载状态**：生成延迟时屏幕中间显示转圈圈UI和"正在合成"文字

